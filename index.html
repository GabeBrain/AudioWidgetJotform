<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>URL Echo Widget</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 1rem; }
    label, input { display: block; width: 100%; }
    input { margin-top: .25rem; padding: .5rem; }
  </style>
  <script src="https://js.jotform.com/JFCustomWidget.min.js"></script>
</head>
<body>
  <label>
    URL to send back:
    <input id="urlInput" placeholder="https://example.com" />
  </label>

  <script>
    console.log('[widget] script loaded');

    const input = document.getElementById('urlInput');

    function trySend(value) {
      if (!window.JFCustomWidget) {
        console.log('[widget] sendData skipped: JFCustomWidget missing');
        return;
      }
      console.log('[widget] sendData', value);
      window.JFCustomWidget.sendData({
        valid: !!value,
        value
      });
    }

    // Retry until JFCustomWidget exists
    let waitCount = 0;
    const handshake = setInterval(() => {
      if (!window.JFCustomWidget) {
        if (waitCount % 20 === 0) {
          console.log('[widget] waiting for JFCustomWidget...', waitCount);
        }
        waitCount += 1;
        return;
      }
      console.log('[widget] JFCustomWidget detected');
      clearInterval(handshake);

      // Tell Jotform we're ready and set current value
      window.JFCustomWidget.subscribe('ready', function (msg) {
        input.value = msg?.value?.value || '';
        trySend(input.value);
      });

      // Acknowledge form submissions so the parent can continue
      window.JFCustomWidget.subscribe('submit', function () {
        const value = input.value.trim();
        console.log('[widget] submit', value);
        window.JFCustomWidget.sendSubmit({
          valid: !!value,
          value
        });
      });

      // Push new value on change
      input.addEventListener('input', () => trySend(input.value.trim()));
    }, 50);
  </script>
</body>
</html>
